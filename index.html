<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sophia — Market Line</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    --midnight-ink: #1a1f2e;
    --pacific-teal: #2a7d7d;
    --signal-amber: #c8922a;
    --light-bg: #f7f5f0;
    --border: #ddd8ce;
    --text-primary: #1a1f2e;
    --text-secondary: #5a6070;
    --white: #ffffff;
    --sidebar-width: 280px;
  }

  body {
    font-family: 'Georgia', 'Times New Roman', serif;
    background: var(--light-bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  .sidebar {
    width: var(--sidebar-width);
    background: var(--midnight-ink);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 24px 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .logo {
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.4);
    margin-bottom: 6px;
  }

  .sophia-title {
    font-size: 22px;
    color: var(--white);
    font-weight: normal;
    letter-spacing: 1px;
  }

  .sophia-subtitle {
    font-size: 11px;
    color: var(--pacific-teal);
    margin-top: 4px;
    letter-spacing: 0.5px;
  }

  .sidebar-section {
    padding: 16px 20px 8px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.3);
  }

  .new-engagement-btn {
    margin: 8px 12px;
    padding: 10px 16px;
    background: var(--pacific-teal);
    color: var(--white);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    text-align: left;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .new-engagement-btn:hover { background: #358585; }

  .engagement-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
  }

  .engagement-item {
    padding: 10px 20px;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
  }

  .engagement-item:hover {
    background: rgba(255,255,255,0.05);
  }

  .engagement-item.active {
    background: rgba(42,125,125,0.15);
    border-left-color: var(--pacific-teal);
  }

  .engagement-name {
    font-size: 13px;
    color: rgba(255,255,255,0.85);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .engagement-meta {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    margin-top: 2px;
  }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .settings-btn {
    font-size: 12px;
    color: rgba(255,255,255,0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    font-family: inherit;
    padding: 4px 0;
    transition: color 0.2s;
  }

  .settings-btn:hover { color: rgba(255,255,255,0.7); }

  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 16px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .header-left h2 {
    font-size: 16px;
    font-weight: normal;
    color: var(--text-primary);
  }

  .header-left p {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 2px;
    font-style: italic;
  }

  .header-tabs {
    display: flex;
    gap: 4px;
  }

  .tab-btn {
    padding: 7px 16px;
    font-family: inherit;
    font-size: 12px;
    border: 1px solid var(--border);
    background: none;
    cursor: pointer;
    border-radius: 3px;
    color: var(--text-secondary);
    transition: all 0.15s;
    letter-spacing: 0.3px;
  }

  .tab-btn.active {
    background: var(--midnight-ink);
    color: var(--white);
    border-color: var(--midnight-ink);
  }

  .tab-btn:hover:not(.active) {
    background: var(--light-bg);
    color: var(--text-primary);
  }

  .content {
    flex: 1;
    overflow: hidden;
    display: flex;
  }

  .panel {
    display: none;
    flex: 1;
    overflow: hidden;
  }

  .panel.active {
    display: flex;
    flex-direction: column;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 28px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .message {
    display: flex;
    gap: 14px;
    max-width: 820px;
  }

  .message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .message-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    flex-shrink: 0;
    letter-spacing: 0.5px;
  }

  .message.sophia .message-avatar {
    background: var(--midnight-ink);
    color: var(--pacific-teal);
    font-size: 10px;
  }

  .message.user .message-avatar {
    background: var(--pacific-teal);
    color: var(--white);
    font-size: 11px;
  }

  .message-content {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 18px;
    font-size: 14px;
    line-height: 1.75;
    color: var(--text-primary);
    max-width: 680px;
  }

  .message.user .message-content {
    background: var(--midnight-ink);
    color: var(--white);
    border-color: var(--midnight-ink);
  }

  .message-content p { margin-bottom: 10px; }
  .message-content p:last-child { margin-bottom: 0; }

  .message-time {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 5px;
    text-align: right;
    font-style: italic;
  }

  .message.user .message-time { text-align: left; }

  .welcome-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }

  .welcome-icon {
    width: 64px;
    height: 64px;
    background: var(--midnight-ink);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    font-size: 11px;
    color: var(--pacific-teal);
    letter-spacing: 1px;
    font-weight: bold;
  }

  .welcome-state h3 {
    font-size: 20px;
    font-weight: normal;
    color: var(--text-primary);
    margin-bottom: 10px;
  }

  .welcome-state p {
    font-size: 14px;
    color: var(--text-secondary);
    max-width: 420px;
    line-height: 1.7;
    font-style: italic;
  }

  .input-area {
    background: var(--white);
    border-top: 1px solid var(--border);
    padding: 16px 28px 20px;
    flex-shrink: 0;
  }

  .input-wrapper {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    max-width: 820px;
  }

  .message-input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px 16px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-primary);
    resize: none;
    min-height: 48px;
    max-height: 160px;
    outline: none;
    transition: border-color 0.2s;
    background: var(--light-bg);
  }

  .message-input:focus {
    border-color: var(--pacific-teal);
    background: var(--white);
  }

  .send-btn {
    padding: 12px 22px;
    background: var(--midnight-ink);
    color: var(--white);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    transition: background 0.2s;
    flex-shrink: 0;
    letter-spacing: 0.3px;
  }

  .send-btn:hover { background: #2a3144; }
  .send-btn:disabled { background: #aaa; cursor: not-allowed; }

  .input-hint {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 8px;
    font-style: italic;
  }

  .ledger-panel {
    padding: 28px;
    overflow-y: auto;
    flex: 1;
  }

  .ledger-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .ledger-header h3 {
    font-size: 16px;
    font-weight: normal;
  }

  .add-entry-btn {
    padding: 8px 16px;
    background: var(--pacific-teal);
    color: var(--white);
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    transition: background 0.2s;
  }

  .add-entry-btn:hover { background: #358585; }

  .ledger-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
    font-style: italic;
    font-size: 14px;
  }

  .ledger-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .ledger-table th {
    background: var(--midnight-ink);
    color: var(--white);
    padding: 10px 14px;
    text-align: left;
    font-weight: normal;
    font-size: 11px;
    letter-spacing: 0.5px;
  }

  .ledger-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
    line-height: 1.5;
  }

  .ledger-table tr:hover td {
    background: rgba(42,125,125,0.04);
  }

  .category-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 10px;
    letter-spacing: 0.5px;
    font-weight: bold;
  }

  .badge-decision { background: #e8f0fe; color: #1a56db; }
  .badge-assumption { background: #fef3c7; color: #92400e; }
  .badge-open { background: #fee2e2; color: #991b1b; }
  .badge-override { background: #f3e8ff; color: #6b21a8; }
  .badge-compliance { background: #dcfce7; color: #166534; }

  .status-open { color: var(--signal-amber); font-weight: bold; font-size: 11px; }
  .status-closed { color: var(--pacific-teal); font-size: 11px; }

  .documents-panel {
    padding: 28px;
    overflow-y: auto;
    flex: 1;
  }

  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 6px;
    padding: 40px;
    text-align: center;
    margin-bottom: 24px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .upload-zone:hover {
    border-color: var(--pacific-teal);
    background: rgba(42,125,125,0.03);
  }

  .upload-zone p {
    font-size: 14px;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 8px;
  }

  .upload-zone input { display: none; }

  .doc-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .doc-item {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .doc-name { font-size: 13px; color: var(--text-primary); }

  .doc-meta {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 2px;
  }

  .doc-remove {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    border-radius: 3px;
    transition: all 0.15s;
  }

  .doc-remove:hover { background: #fee2e2; color: #991b1b; }

  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--white);
    border-radius: 6px;
    padding: 32px;
    width: 460px;
    max-width: 90vw;
  }

  .modal h3 {
    font-size: 18px;
    font-weight: normal;
    margin-bottom: 6px;
  }

  .modal p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
    font-style: italic;
  }

  .form-group {
    margin-bottom: 18px;
  }

  .form-group label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
    letter-spacing: 0.3px;
    text-transform: uppercase;
  }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: inherit;
    font-size: 13px;
    color: var(--text-primary);
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--pacific-teal);
  }

  .form-group input[type="password"] { letter-spacing: 2px; }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  .btn-primary {
    padding: 10px 22px;
    background: var(--midnight-ink);
    color: var(--white);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    transition: background 0.2s;
  }

  .btn-primary:hover { background: #2a3144; }

  .btn-secondary {
    padding: 10px 22px;
    background: none;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    transition: all 0.2s;
  }

  .btn-secondary:hover { border-color: var(--text-secondary); color: var(--text-primary); }

  .new-engagement-modal .form-group textarea {
    min-height: 80px;
    resize: vertical;
  }

  .ledger-modal .form-group textarea {
    min-height: 70px;
    resize: vertical;
  }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 4px 0;
    align-items: center;
  }

  .typing-dot {
    width: 7px;
    height: 7px;
    background: var(--pacific-teal);
    border-radius: 50%;
    animation: typing 1.2s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #bbb; }

  .no-engagement {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    color: var(--text-secondary);
    font-style: italic;
    font-size: 14px;
  }

  .draft-notice {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 4px;
    padding: 8px 14px;
    font-size: 12px;
    color: #92400e;
    margin-bottom: 16px;
    text-align: center;
    font-style: italic;
  }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo">Market Line</div>
    <div class="sophia-title">Sophia</div>
    <div class="sophia-subtitle">Senior Valuation Advisor</div>
  </div>
  <div class="sidebar-section">Engagements</div>
  <button class="new-engagement-btn" onclick="openNewEngagementModal()">
    <span>+</span> New Engagement
  </button>
  <div class="engagement-list" id="engagementList"></div>
  <div class="sidebar-footer">
    <button class="settings-btn" onclick="openSettings()">Settings &amp; API Key</button>
  </div>
</div>

<div class="main">
  <div class="no-engagement" id="noEngagement">
    <div style="font-size: 40px; opacity: 0.2;">&#9878;</div>
    <p>Select or create an engagement to begin.</p>
  </div>

  <div id="engagementView" style="display: none;">
    <div class="header">
      <div class="header-left">
        <h2 id="engagementTitle">Engagement</h2>
        <p id="engagementSubtitle">Market Line — Confidential</p>
      </div>
      <div class="header-tabs">
        <button class="tab-btn active" onclick="switchTab('chat', this)">Conversation</button>
        <button class="tab-btn" onclick="switchTab('ledger', this)">Decisions &amp; Assumptions</button>
        <button class="tab-btn" onclick="switchTab('documents', this)">Documents</button>
      </div>
    </div>

    <div class="panel active" id="panel-chat">
      <div class="chat-messages" id="chatMessages">
        <div class="welcome-state">
          <div class="welcome-icon">ML</div>
          <h3>I am Sophia.</h3>
          <p>Your senior valuation advisor and thinking partner at Market Line. Tell me what you are working on and I am listening.</p>
        </div>
      </div>
      <div class="input-area">
        <div class="input-wrapper">
          <textarea class="message-input" id="messageInput" placeholder="Begin the conversation..." rows="1" onkeydown="handleKeydown(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
        <div class="input-hint">Press Enter to send · Shift+Enter for new line</div>
      </div>
    </div>

    <div class="panel" id="panel-ledger">
      <div class="ledger-panel">
        <div class="draft-notice">All outputs are internal drafts pending Managing Director review before external use.</div>
        <div class="ledger-header">
          <h3>Decisions &amp; Assumptions Ledger</h3>
          <button class="add-entry-btn" onclick="openLedgerModal()">+ Add Entry</button>
        </div>
        <div id="ledgerContent">
          <div class="ledger-empty">No entries yet. Sophia will populate this ledger as the engagement develops.</div>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-documents">
      <div class="documents-panel">
        <div class="draft-notice">All outputs are internal drafts pending Managing Director review before external use.</div>
        <h3 style="font-size: 16px; font-weight: normal; margin-bottom: 16px;">Engagement Documents</h3>
        <label class="upload-zone" for="fileUpload">
          <div style="font-size: 28px; opacity: 0.3;">&#128206;</div>
          <p>Click to upload documents</p>
          <input type="file" id="fileUpload" multiple onchange="handleFileUpload(event)">
        </label>
        <div class="doc-list" id="docList"></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h3>Settings</h3>
    <p>Enter your Anthropic API key. It is stored locally in your browser and never transmitted anywhere except directly to Anthropic.</p>
    <div class="form-group">
      <label>Anthropic API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- NEW ENGAGEMENT MODAL -->
<div class="modal-overlay new-engagement-modal" id="newEngagementModal">
  <div class="modal">
    <h3>New Engagement</h3>
    <p>Create a workspace for a new client engagement.</p>
    <div class="form-group">
      <label>Client Name</label>
      <input type="text" id="newClientName" placeholder="e.g. Henderson Group">
    </div>
    <div class="form-group">
      <label>Engagement Type</label>
      <select id="newEngagementType">
        <option value="">Select type...</option>
        <option value="M&A Advisory">M&A Advisory</option>
        <option value="Tax Valuation">Tax Valuation</option>
        <option value="Purchase Price Allocation">Purchase Price Allocation</option>
        <option value="Shareholder Value Advisory">Shareholder Value Advisory</option>
        <option value="Financial Reporting Valuation">Financial Reporting Valuation</option>
        <option value="Litigation Support">Litigation Support</option>
        <option value="Strategic Advisory">Strategic Advisory</option>
        <option value="Brainstorming">Brainstorming</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="newEngagementNotes" placeholder="Brief description or initial context..." style="min-height: 80px; resize: vertical;"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeNewEngagementModal()">Cancel</button>
      <button class="btn-primary" onclick="createEngagement()">Create Engagement</button>
    </div>
  </div>
</div>

<!-- LEDGER ENTRY MODAL -->
<div class="modal-overlay ledger-modal" id="ledgerModal">
  <div class="modal">
    <h3>Add Ledger Entry</h3>
    <p>Document a decision, assumption, open question, override or compliance note.</p>
    <div class="form-group">
      <label>Category</label>
      <select id="ledgerCategory">
        <option value="Decision">Decision</option>
        <option value="Assumption">Assumption</option>
        <option value="Open Question">Open Question</option>
        <option value="Override">Override</option>
        <option value="Compliance Note">Compliance Note</option>
      </select>
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="ledgerDescription" placeholder="What was decided, assumed, or queried?" style="min-height: 70px; resize: vertical;"></textarea>
    </div>
    <div class="form-group">
      <label>Rationale</label>
      <textarea id="ledgerRationale" placeholder="Why was this decision or assumption made?" style="min-height: 70px; resize: vertical;"></textarea>
    </div>
    <div class="form-group">
      <label>Impact</label>
      <input type="text" id="ledgerImpact" placeholder="Which valuation lever or report section does this affect?">
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeLedgerModal()">Cancel</button>
      <button class="btn-primary" onclick="saveLedgerEntry()">Add Entry</button>
    </div>
  </div>
</div>

<script>
let state = {
  apiKey: localStorage.getItem('sophia_api_key') || '',
  engagements: JSON.parse(localStorage.getItem('sophia_engagements') || '[]'),
  activeEngagementId: null,
  isThinking: false
};

function init() {
  renderEngagementList();
  if (!state.apiKey) setTimeout(openSettings, 500);
}

function openNewEngagementModal() {
  document.getElementById('newEngagementModal').classList.add('active');
  document.getElementById('newClientName').focus();
}

function closeNewEngagementModal() {
  document.getElementById('newEngagementModal').classList.remove('active');
  document.getElementById('newClientName').value = '';
  document.getElementById('newEngagementType').value = '';
  document.getElementById('newEngagementNotes').value = '';
}

function createEngagement() {
  const name = document.getElementById('newClientName').value.trim();
  const type = document.getElementById('newEngagementType').value;
  const notes = document.getElementById('newEngagementNotes').value.trim();
  if (!name) { document.getElementById('newClientName').focus(); return; }

  const engagement = {
    id: Date.now().toString(),
    name,
    type: type || 'General',
    notes,
    created: new Date().toISOString(),
    messages: [],
    ledger: [],
    documents: []
  };

  state.engagements.unshift(engagement);
  saveState();
  renderEngagementList();
  closeNewEngagementModal();
  selectEngagement(engagement.id);
}

function selectEngagement(id) {
  state.activeEngagementId = id;
  const engagement = getActiveEngagement();
  if (!engagement) return;

  document.getElementById('noEngagement').style.display = 'none';
  const ev = document.getElementById('engagementView');
  ev.style.display = 'flex';
  ev.style.flexDirection = 'column';
  ev.style.overflow = 'hidden';
  ev.style.flex = '1';

  document.getElementById('engagementTitle').textContent = engagement.name;
  document.getElementById('engagementSubtitle').textContent = engagement.type + ' — Market Line Confidential';

  renderEngagementList();
  switchTab('chat', document.querySelector('.tab-btn'));
  renderMessages();
  renderLedger();
  renderDocuments();
}

function getActiveEngagement() {
  return state.engagements.find(e => e.id === state.activeEngagementId);
}

function renderEngagementList() {
  const list = document.getElementById('engagementList');
  if (state.engagements.length === 0) {
    list.innerHTML = '<div style="padding: 12px 20px; font-size: 12px; color: rgba(255,255,255,0.25); font-style: italic;">No engagements yet.</div>';
    return;
  }
  list.innerHTML = state.engagements.map(e =>
    '<div class="engagement-item ' + (e.id === state.activeEngagementId ? 'active' : '') + '" onclick="selectEngagement(\'' + e.id + '\')">' +
    '<div class="engagement-name">' + e.name + '</div>' +
    '<div class="engagement-meta">' + e.type + ' · ' + formatDate(e.created) + '</div></div>'
  ).join('');
}

function renderMessages() {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  const container = document.getElementById('chatMessages');

  if (engagement.messages.length === 0) {
    container.innerHTML = '<div class="welcome-state"><div class="welcome-icon">ML</div><h3>I am Sophia.</h3><p>Your senior valuation advisor and thinking partner at Market Line. Tell me what you are working on and I am listening.</p></div>';
    return;
  }

  container.innerHTML = engagement.messages.map(m =>
    '<div class="message ' + (m.role === 'user' ? 'user' : 'sophia') + '">' +
    '<div class="message-avatar">' + (m.role === 'user' ? 'You' : 'S') + '</div>' +
    '<div><div class="message-content">' + formatMessage(m.content) + '</div>' +
    '<div class="message-time">' + formatTime(m.timestamp) + '</div></div></div>'
  ).join('');

  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  if (state.isThinking) return;
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  if (!state.apiKey) { openSettings(); return; }

  const engagement = getActiveEngagement();
  if (!engagement) return;

  engagement.messages.push({ role: 'user', content: text, timestamp: new Date().toISOString() });
  input.value = '';
  input.style.height = 'auto';
  saveState();
  renderMessages();

  state.isThinking = true;
  document.getElementById('sendBtn').disabled = true;
  showTypingIndicator();

  try {
    const apiMessages = engagement.messages.map(m => ({ role: m.role, content: m.content }));

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: apiMessages, api_key: state.apiKey })
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error);

    engagement.messages.push({ role: 'assistant', content: data.content, timestamp: new Date().toISOString() });
    saveState();
  } catch (error) {
    engagement.messages.push({ role: 'assistant', content: 'I encountered an issue: ' + error.message + '. Please check your API key in Settings and try again.', timestamp: new Date().toISOString() });
    saveState();
  } finally {
    state.isThinking = false;
    document.getElementById('sendBtn').disabled = false;
    removeTypingIndicator();
    renderMessages();
  }
}

function showTypingIndicator() {
  const container = document.getElementById('chatMessages');
  const indicator = document.createElement('div');
  indicator.className = 'message sophia';
  indicator.id = 'typingIndicator';
  indicator.innerHTML = '<div class="message-avatar">S</div><div class="message-content"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>';
  container.appendChild(indicator);
  container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

function handleKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
}

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
}

function renderLedger() {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  const container = document.getElementById('ledgerContent');

  if (!engagement.ledger || engagement.ledger.length === 0) {
    container.innerHTML = '<div class="ledger-empty">No entries yet. Sophia will populate this ledger as the engagement develops.</div>';
    return;
  }

  const badgeClass = { 'Decision': 'badge-decision', 'Assumption': 'badge-assumption', 'Open Question': 'badge-open', 'Override': 'badge-override', 'Compliance Note': 'badge-compliance' };

  let html = '<table class="ledger-table"><thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Rationale</th><th>Impact</th><th>Status</th></tr></thead><tbody>';
  engagement.ledger.forEach((entry, i) => {
    html += '<tr><td style="white-space:nowrap;">' + formatDate(entry.date) + '</td>';
    html += '<td><span class="category-badge ' + (badgeClass[entry.category] || '') + '">' + entry.category + '</span></td>';
    html += '<td>' + entry.description + '</td>';
    html += '<td>' + entry.rationale + '</td>';
    html += '<td>' + entry.impact + '</td>';
    html += '<td><span class="' + (entry.status === 'Open' ? 'status-open' : 'status-closed') + '">' + entry.status + '</span>';
    if (entry.status === 'Open') html += '<br><button onclick="closeLedgerEntry(' + i + ')" style="font-size:10px;color:var(--pacific-teal);background:none;border:none;cursor:pointer;margin-top:4px;">Close</button>';
    html += '</td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function openLedgerModal() { document.getElementById('ledgerModal').classList.add('active'); }
function closeLedgerModal() {
  document.getElementById('ledgerModal').classList.remove('active');
  document.getElementById('ledgerDescription').value = '';
  document.getElementById('ledgerRationale').value = '';
  document.getElementById('ledgerImpact').value = '';
}

function saveLedgerEntry() {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  const desc = document.getElementById('ledgerDescription').value.trim();
  if (!desc) { document.getElementById('ledgerDescription').focus(); return; }

  if (!engagement.ledger) engagement.ledger = [];
  engagement.ledger.push({
    date: new Date().toISOString(),
    category: document.getElementById('ledgerCategory').value,
    description: desc,
    rationale: document.getElementById('ledgerRationale').value.trim(),
    impact: document.getElementById('ledgerImpact').value.trim(),
    status: 'Open'
  });
  saveState();
  closeLedgerModal();
  renderLedger();
}

function closeLedgerEntry(index) {
  const engagement = getActiveEngagement();
  if (!engagement || !engagement.ledger[index]) return;
  engagement.ledger[index].status = 'Closed';
  saveState();
  renderLedger();
}

function handleFileUpload(event) {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  if (!engagement.documents) engagement.documents = [];
  Array.from(event.target.files).forEach(file => {
    engagement.documents.push({ name: file.name, size: file.size, uploaded: new Date().toISOString() });
  });
  saveState();
  renderDocuments();
  event.target.value = '';
}

function renderDocuments() {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  const list = document.getElementById('docList');
  if (!engagement.documents || engagement.documents.length === 0) { list.innerHTML = ''; return; }
  list.innerHTML = engagement.documents.map((doc, i) =>
    '<div class="doc-item"><div><div class="doc-name">' + doc.name + '</div>' +
    '<div class="doc-meta">Uploaded ' + formatDate(doc.uploaded) + ' · ' + formatSize(doc.size) + '</div></div>' +
    '<button class="doc-remove" onclick="removeDocument(' + i + ')">x</button></div>'
  ).join('');
}

function removeDocument(index) {
  const engagement = getActiveEngagement();
  if (!engagement) return;
  engagement.documents.splice(index, 1);
  saveState();
  renderDocuments();
}

function openSettings() {
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('settingsModal').classList.add('active');
}

function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }

function saveSettings() {
  state.apiKey = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('sophia_api_key', state.apiKey);
  closeSettings();
}

function switchTab(tab, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  if (btn) btn.classList.add('active');
}

function saveState() {
  localStorage.setItem('sophia_engagements', JSON.stringify(state.engagements));
}

function formatDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
}

function formatTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
}

function formatSize(bytes) {
  if (!bytes) return '';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function formatMessage(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>');
}

init();
</script>
</body>
</html>